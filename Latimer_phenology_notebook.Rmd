---
title: "Latimer_phenology_notebook"
author: "Data collected by John Latimer<br/>data annotated by Claudia Nanninga <br/> code written by David J. Weston<br/>Travis Lawrence"
date: "12/01/2018"
output:
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
  pdf_document:
    toc: yes
---

# Introduction

The goal of this R notebook tutorial is to intorduce the public to the importance of community science along with its inherent limitations. 

We are using a dataset collected by community scientist John Latimer for over 32 years. Data were meticulously curated by Claudia Nanninga. These data are publically available along with introductory ananlysis code at https://github.com/dwestontn/Latimer_phenology. See Medium blog TK###### for further insights.


```{r setup, include=FALSE}

library(captioner)

fig_nums <- captioner(prefix = "Fig.")
fig.1_cap <- fig_nums(name = "fig_1", 
                        caption = "2018 data, change in growth (initial weight (wt) - final wt among the two symbiotic partners alone and when added togather but grown seperately (_seperate) and when grown together in same well (_symbiosis). Cyano in symbiosis includes, endophytes, epiphytes and free living cyano.  Data incuded all pH conditions")

```


# 2018 Data import and initials glimpse


The origianl data provided by Latimer is in typical date format. However, ecolgists and climate scientist often use Julian day format to provide a continuous count of the days starting at January 1st each year. Each year will contain 365 days or 366 days if a leap years

Code for changing the date format to the Julian day format was modified from the Neon site: https://www.neonscience.org/julian-day-conversion-r


```{r, echo=FALSE, message=FALSE}
library(lubridate)
library(tidyverse)

datphen<-read.csv("Latimer_Cleaned_1.csv")
#str(datphen) #describes data class of columns within dataframe
#dim(datphen) #dimension of the dataframe

# From str(datphen) output see that 'date' is factor. change to 'date' class:

datphen$date<- as.Date(datphen$date, "%m/%d/%y")
#str(datphen) #to confirm class change

head(datphen)


```

The data are impressive! Over a 32 year span, Latimer manually collected 10,484 phenology observations. Along with the date recorded, Latimer and Nanninga added 9 other vairable (e.g., genus, species, common name, lifeform, etc.) for a total of 104,840 total observations. This is just the start, our dataset stops at 2016 while latimer continues to record phenology observations. 


```{r, echo=FALSE, message=FALSE}

#Add columns for month, year and julian day to datphen
datphen2<-datphen %>% mutate(month = format(date, "%m"), year = format(date, "%Y"), julian = yday(date))

#quick data checkt to confirm new columns are OK especiallu given leap years.
datphen2 %>% group_by(year) %>% summarize(max(julian), min(julian))
```


We can see from the above partial table that Latimer did not record observations daily. This makes sense as plants are dormant in the winter and many birds migrate.

As a quick check on the Julian day conversion, I looked at 06-27 julian days. on regular years it is 178, on leap years (2000,2004,2008,2012, etc) it is 179. That was confirmed for this one date. 

Now lets get a feel for the data, espeically in regard to plants. 

```{r, echo=FALSE, message=FALSE}

# Subset of all data that includes plants that were observed for flowering.
datphen2 %>% select(common_name, lifeform, event) %>% filter(lifeform == "PLANTS" & event =="FLOWERING") %>% group_by(common_name) %>% tally() %>% arrange(-n)

```

From the above table, we see that there are 392 plants that were observed over the years. However, many have a sparse number of observations that are difficult to build models for. 

Here is a look at the data distribution

```{r, echo=FALSE, message=FALSE}

a<-datphen2 %>% select(common_name, lifeform, event) %>% filter(lifeform == "PLANTS" & event =="FLOWERING") %>% group_by(common_name) %>% tally() %>% arrange(-n)



  ggplot(a, mapping = aes(x = reorder(common_name, -n), y = n)) +
  geom_bar(colour="black", fill="blue", stat = "identity") +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_text(size=16),
        axis.title=element_text(size=16,face="bold"),
        plot.title = element_text(size=22),
        axis.ticks.x=element_blank()) +
  labs(title = "Observations per plant species over 32 years", x = "Plant Species as Categories", y = "Number of observations per species")


```

We can see from the histogram that the majority of data are sparse indeed, with less than 10 observations. 


If we subset the data to those plants that have at least 15 or more observations, we still get 76 plant speices (see code below). this is a considerable number of plants for trends in phenology at one location. To interrogate the data further, lets restrict the phenology traits to flowering time only, and tidy the data for recursive linear model fitting.


```{r, echo=FALSE, message=FALSE}

#subset for those speices that have 15 or more years of flowering observations
b<- a %>% filter(n >= 15)
c<-b %>% select(common_name)

#now make a dataframe that has all observation from only the species meeting out criteron (common name in dataframe b)

lm.data<-inner_join(c, datphen2, by = "common_name") %>% filter(event =="FLOWERING") #%>% group_by(common_name) %>% distinct(year, .keep_all = TRUE)

lm.data$year<-as.numeric(lm.data$year)


```

Now that the data are tidy (in a format to easily compute on), lets run a linear model across all 76 species through the 32 years of data. Further, lets extract the model slope and P - value to identify candidate species for further investigation on flowing time correlations with time of year. 

```{r, echo=FALSE, message=FALSE}

library(broom)

#running the lm model across all rows, genotypes
lm.results<- lm.data %>% group_by(common_name) %>% do(fitdata = lm(julian ~ year, data = .))

#getting tidy data output from model run
lmSlopePvalue <- tidy(lm.results, fitdata) %>% select(common_name, term, estimate, p.value) %>% filter(term =="year")

lmRsquare <- glance(lm.results, fitdata) %>% select(common_name, r.squared)

#tidy data output
lmtidyoutput<-left_join(lmSlopePvalue, lmRsquare, by = c("common_name" = "common_name"))

# lm model parameter distributions

par(mfrow=c(1,3))
hist(lmtidyoutput$estimate, main = "lm slope")
hist(lmtidyoutput$p.value, main = "P value")
hist(lmtidyoutput$r.squared, main = "r2")


```


The above histograms show distirbutions of linear model paramters. 


```{r, echo=FALSE, message=FALSE}
par(mfrow=c(1,3))
plot(lmtidyoutput$p.value, lmtidyoutput$estimate, main = "p.value to slope")
plot(lmtidyoutput$r.squared, lmtidyoutput$estimate, main = "r.squared to slope")
plot(lmtidyoutput$p.value, lmtidyoutput$r.squared, main = "p.value to r.squared")
```


The above scatterplots show the relationships for linear model paramters to each other. 


The linear model output indicates that changes flowering day for Big Toothed Aspen is associated with year observed. To look at the relationship further, lets plot year by Julian day for first observed flowering of Big Toothed Aspen.

```{r, echo=FALSE, message=FALSE}

#looking at big toothed aspen flowering

datphen2$year<- as.numeric(datphen2$year)

datphen2 %>% filter(common_name=="BIG TOOTHED ASPEN" & event=="FLOWERING") %>% ggplot(aes(y= julian, x= year)) +
  geom_point()+
  geom_smooth(method = lm) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.text=element_text(size=16)) +
  labs(title = "Date of Big Toothed Aspen observed first flower", x = "Year", y = "Julian Calendar Day")

```


Notice that there are not many observations between 1990 and 2000. To add confidence to the regression trend lets restrict the analysis to those years above 2000.


```{r, echo=FALSE, message=FALSE, warning=FALSE}

datphen2 %>% filter(year > 2000 & common_name=="BIG TOOTHED ASPEN" & event=="FLOWERING") %>% ggplot(aes(y= julian, x= year)) +
  geom_point()+
  geom_smooth(method = lm) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.text=element_text(size=16)) +
  labs(title = "Date of Big Toothed Aspen fist flower", x = "Year", y = "Julian Calendar Day")


```


The trend between the two above graphs is similar, suggesting that Big Toothed Aspen is pregressively flowering earlier in the season. 

now lets look at trends across other plants, do they all show the same trend?



```{r, echo=FALSE, message=FALSE}


#subset for those speices that have more than 15 years of flwoering observations
b<- a %>% filter(n > 15)
c<-b %>% select(common_name)

#now make a dataframe that has all observation from only the species meeting out criteron (common name in dataframe b)

lm.data<-inner_join(c, datphen2, by = "common_name") %>% filter(event =="FLOWERING")

```

We can see that dataframe b has 67 rows, meaning that only 67 plant species have 15 or more observations for this analysis. 


Now lets write code for a model that looks for regression trends among flowering day and year for all plant species meeting a 15 year minimum criteron. 


```{r, echo=FALSE, message=FALSE}

#now lets graph the data and see what it looks like
#select the p.value cutoff

trash<-lmtidyoutput %>% filter(p.value <=0.05) %>% select(common_name)

trash2<-left_join(trash, datphen2, by = c("common_name" = "common_name"))

ggplot(trash2, aes(y= julian, x= year, colour = common_name, group = common_name)) +
  geom_point()+
  geom_quantile() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.text=element_text(size=16)) 

#determine how many species meet our criteria

trash3<-trash2 %>% filter(event == "FLOWERING")
    
## start of plotting function

plant.species <- function(df, na.rm = TRUE, ...){
  
  # create list of counties in data to loop over 
  plant_list <- unique(df$common_name)
  
  # create for loop to produce ggplot2 graphs 
  for (i in seq_along(plant_list)) { 
    
    # create plot for each county in df 
    plot <- 
      ggplot(subset(df, df$common_name==plant_list[i]),
        aes(y= julian, x= year, group = common_name)) + 
        geom_point(size=4, colour = "dark blue")+
        geom_smooth(method = lm) +
        theme(axis.text=element_text(size=12),
        axis.title=element_text(size=16,face="bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.text=element_text(size=16)) +
        ggtitle(paste(plant_list[i]))
    
    # save plots as .png
    # ggsave(plot, file=paste(results, 
    #                        'projection_graphs/county_graphs/',
    #                        plant_list[i], ".png", sep=''), scale=2)
   
    # save plots as .pdf
    # ggsave(plot, file=paste(results, 
    #                        'projection_graphs/county_graphs/',
    #                        plant_list[i], ".pdf", sep=''), scale=2)
    
    # print plots to screen
    print(plot)
  }
}

# run graphing function on long df
plant.species(trash3)

```

The graphs show some interesting trends, some species seem to flower earlier in the year - like Big Toothed Aspen, while others may be flowering later in the year. See False Solomon's Seal as an example. To really have confidence in these trends, one would need to determine that linear model assumptions are met. please refer to TKXXXXXX.....


Using the above code one can explore the Latimer bird data in a similar way. If you do so, you will notice that the bird data is much more sparse than the plant data. Suggesting that Latimer was more interested in observing plant phenology than bird phenology. Below is an example graph chosen because of numerous observations (abundant data) that exhibit a seeminly non-responive trend. An informed public must keep in mind that graphs showing exagerated trends may not be the norm, indeed the DarK Eyed Junco seems to be non-responsive to year observed - see below


```{r, echo=FALSE, message=FALSE}
datphen2 %>% filter(common_name=="DARK EYED JUNCO" & event=="FIRST SEEN") %>% ggplot(aes(y= julian, x= year)) +
  geom_point(size=4, colour = "dark blue")+
  geom_smooth(method = lm) +
  theme(axis.text=element_text(size=18),
        axis.title=element_text(size=20,face="bold"),
        plot.title = element_text(size=20, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.text=element_text(size=20)) +
        scale_y_continuous(limits = c(0, 200)) +
  labs(title = "Date when Dark Eyed Junco was first seen", x = "Year", y = "Julian Calendar Day")
```






